# Copyright (c) 2014 Critical Stack LLC.  All Rights Reserved.
# Liam Randall (@Hectaman)

# Set of detection routines to monitor for CVE-2014-6271

# CHANGES:
#	2014-9-7 Initial support for http header vector via mod_cgi

module Bash;

export {
	redef enum Notice::Type += {
		## Indicates that a host may have attempted a bash cgi header attack
		HTTP_Header_Attack,
	};
}

event http_header(c: connection, is_orig: bool, name: string, value: string) &priority=3
	{

	if ( is_orig )
		{
#		This particular string seems to be necessary
# 		  larger ranges are also hitting on cookies, eg: ( /\x7b.*\x7d.*\x3b/ in value )
		if ( /\x28\x29\x20\x7b\x20/ in value)
			{
			NOTICE([$note=Bash::HTTP_Header_Attack,
				$conn=c,
				$msg=fmt("%s may have attempted to exploit CVE-2014-6271, bash environment variable attack, via HTTP mod_cgi header against %s submitting \"%s\"=\"%s\"",c$id$orig_h, c$id$resp_h, name, value),
				$identifier=c$uid]);
			}
		}
	
	}
